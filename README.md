# ralph-parallel

Parallel spec execution plugin for [Claude Code](https://claude.com/claude-code). Works with [ralph-specum](https://github.com/tzachbon/smart-ralph) to dispatch spec tasks to Agent Teams for concurrent execution.

## What It Does

Takes a spec generated by ralph-specum, analyzes task dependencies and file ownership, then dispatches parallelizable groups to Agent Team teammates for simultaneous execution. Coordinates the team through phase gates and quality checkpoints.

## Install

```
/install-plugin kavanaghpatrick/ralph-parallel
```

Requires [ralph-specum](https://github.com/tzachbon/smart-ralph) to be installed first.

## Quick Start

```
# 1. Create a spec with ralph-specum
/ralph-specum:new my-feature Add user authentication

# 2. Run through spec phases (research -> requirements -> design -> tasks)
/ralph-specum:requirements
/ralph-specum:design
/ralph-specum:tasks

# 3. Dispatch tasks in parallel
/ralph-parallel:dispatch my-feature

# 4. Monitor progress
/ralph-parallel:status
```

## Commands

| Command | Description |
|---------|-------------|
| `/ralph-parallel:dispatch [spec] [flags]` | Analyze tasks, partition into groups, spawn teammates |
| `/ralph-parallel:status [spec]` | Monitor parallel execution progress |
| `/ralph-parallel:merge [spec]` | Verify and integrate results (worktree strategy only) |

### Dispatch Flags

| Flag | Default | Description |
|------|---------|-------------|
| `--max-teammates N` | 4 | Maximum number of parallel teammates (max 8) |
| `--strategy` | `file-ownership` | Isolation strategy: `file-ownership` or `worktree` |
| `--dry-run` | - | Show partition plan without dispatching |
| `--abort` | - | Cancel active dispatch and shut down teammates |
| `--reclaim` | - | Reclaim coordinator ownership for current session |

## Strategies

### File Ownership (default)

Each teammate owns specific files and can only modify those files. The `PreToolUse` hook enforces ownership at runtime. No merge step needed -- dispatch completes automatically.

Best for: Most specs. Tasks with clear file boundaries.

### Worktree

Each teammate gets an isolated git worktree branch. All files are accessible. Requires `/ralph-parallel:merge` after all teammates complete to integrate branches.

Best for: Tasks with heavy file overlap or circular dependencies.

## How It Works

1. **Validate**: Checks `tasks.md` format via `validate-tasks-format.py`
2. **Parse**: Reads tasks, builds a dependency graph with phase ordering
3. **Partition**: Groups tasks by file ownership (or round-robin for worktree)
4. **Dispatch**: Creates an Agent Team, spawns teammates with scoped prompts
5. **Coordinate**: Manages phase gates, quality checks, and teammate lifecycle
6. **Complete**: Runs `mark-tasks-complete.py`, shuts down team, marks dispatch merged

## Quality Gates

Every task goes through a 6-stage quality gate before completion:

| Stage | Check | When |
|-------|-------|------|
| 1 | Task verify command | Every task |
| 2 | Typecheck | Every task (if configured) |
| 3 | File existence | Every task |
| 4 | Build | Every 3rd task (if configured) |
| 5 | Test suite + regression | Every 2nd task (if configured) |
| 6 | Lint | Every 3rd task (if configured) |

Quality commands are auto-discovered from `package.json`, `Cargo.toml`, `pyproject.toml`, or `Makefile`. You can also declare them explicitly in `tasks.md`:

```markdown
## Quality Commands
- **Build**: `cargo build`
- **Test**: `cargo test`
- **Lint**: `cargo clippy -- -D warnings`
```

## Hooks

| Hook | Event | Purpose |
|------|-------|---------|
| `session-setup.sh` | SessionStart | Detect active dispatches, manage `gc.auto`, auto-reclaim session |
| `file-ownership-guard.sh` | PreToolUse (Write/Edit) | Block writes outside owned files |
| `task-completed-gate.sh` | TaskCompleted | 6-stage quality gate per task |
| `dispatch-coordinator.sh` | Stop | Re-inject coordination context after compaction |

## Pre-defined Groups

You can pre-define groups in `tasks.md` for direct control over partitioning:

```markdown
### Group 1: api-layer [Phase 1]
**Files owned**: `src/api/auth.ts`, `src/api/middleware.ts`

- [ ] 1.1 [P] Add auth endpoint
  - **Files**: `src/api/auth.ts`
  - **Verify**: `npm test`
```

When pre-defined groups are present, the partitioner uses them directly instead of computing automatic partitions.

## Dispatch Lifecycle

```
(none) --> dispatched --> merged        (file-ownership: automatic)
                     --> merging --> merged  (worktree: via /merge)
                     --> stale          (team lost mid-dispatch)
                     --> superseded     (new dispatch for same spec)
                     --> aborted        (via --abort)
```

Stale dispatches are auto-detected on `SessionStart` when the team is dead but work is incomplete. Run `/ralph-parallel:dispatch` to re-dispatch or `--abort` to cancel.

## Demo Results

| Spec | Tasks | Teammates | Result |
|------|-------|-----------|--------|
| user-auth | 12 | 4 | ~3.4x speedup vs serial |
| api-dashboard | 4 | 2 | All quality gates passed |
| gpu-graphics-demo | 12 | 3 | Full Rust/wgpu app, all gates passed |
| forge-sdk-v6 | 52 | 4 | 339 tests (from 126 baseline), 34 commits |

## Requirements

- Claude Code with Agent Teams support
- ralph-specum plugin (for spec generation)
- Python 3.10+ (for analysis scripts)
- `jq` (used by shell hooks)
